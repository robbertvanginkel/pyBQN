import inspect
from multiprocessing import Value
import unittest
import math

from pybqn.provide import provides
from pybqn.vm import VM
from pybqn.runtime import r0, r1, r, bqnstr


class RuntimeTest(unittest.TestCase):
    def test_r0(self):
        vm = VM(*r0(provides))
        self.assertIsNotNone(vm())

    def test_r1(self):
        runtime_0 = VM(*r0(provides))()
        runtime_1 = VM(*r1(provides, runtime_0))()
        self.assertIsNotNone(runtime_1)

    def test_runtime(self):
        self.assertIsNotNone(VM(*r(provides))())


class PrimitiveTests(unittest.TestCase):
    """https://github.com/mlochbaum/BQN/blob/f4b09b675386c789c8296c96874871916a3abdcf/test/cases/prim.bqn

    pbpaste | tr '\n' '\0' | xargs -n1 -0 bqn utils/cpy.bqn ../../BQN
    """

    def test_layer0(self):
        runtime, set_prims, set_inv = VM(*r(provides))()
        # fmt: off
        cases = {
            "0â‰¡Â¯2+2"                    : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[0],runtime[18],0,-2,2],[[0,1,0]],[[0,0]]]),
            "1e4â‰¡5e3+5e3"               : (1, [[0,3,0,0,0,3,17,0,1,0,2,17,7],[runtime[0],runtime[18],10000,5000],[[0,1,0]],[[0,0]]]),
            "'c'â‰¡'a'+2"                 : (1, [[0,2,0,0,0,4,17,0,1,0,3,17,7],[runtime[0],runtime[18],2,'c','a'],[[0,1,0]],[[0,0]]]),
            "'a'â‰¡Â¯2+'c'"                : (1, [[0,4,0,0,0,2,17,0,1,0,3,17,7],[runtime[0],runtime[18],-2,'a','c'],[[0,1,0]],[[0,0]]]),
            "'a'+'c'"                   : (TypeError, [[0,2,0,0,0,1,17,7],[runtime[0],'a','c'],[[0,1,0]],[[0,0]]]),
            "Fâ†-â‹„f+2"                   : (TypeError, [[0,1,33,0,0,48,6,0,2,0,0,34,0,0,17,7],[runtime[0],runtime[1],2],[[0,1,0]],[[0,1]]]),
            "Â¯4â‰¡+Â¯4"                    : (1, [[0,2,0,0,16,0,1,0,2,17,7],[runtime[0],runtime[18],-4],[[0,1,0]],[[0,0]]]),
            "+'x'"                      : (TypeError, [[0,1,0,0,16,7],[runtime[0],'x'],[[0,1,0]],[[0,0]]]),
            "Fâ†-â‹„+f"                    : (TypeError, [[0,1,33,0,0,48,6,34,0,0,0,0,16,7],[runtime[0],runtime[1]],[[0,1,0]],[[0,1]]]),
            "Â¯âˆâ‰¡1e6-âˆ"                  : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[1],runtime[18],-math.inf,1000000,math.inf],[[0,1,0]],[[0,0]]]),
            "4â‰¡-Â¯4"                     : (1, [[0,3,0,0,16,0,1,0,2,17,7],[runtime[1],runtime[18],4,-4],[[0,1,0]],[[0,0]]]),
            "Â¯âˆâ‰¡-âˆ"                     : (1, [[0,3,0,0,16,0,1,0,2,17,7],[runtime[1],runtime[18],-math.inf,math.inf],[[0,1,0]],[[0,0]]]),
            "âˆâ‰¡-Â¯âˆ"                     : (1, [[0,3,0,0,16,0,1,0,2,17,7],[runtime[1],runtime[18],math.inf,-math.inf],[[0,1,0]],[[0,0]]]),
            "4â‰¡9-5"                     : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[1],runtime[18],4,9,5],[[0,1,0]],[[0,0]]]),
            "@â‰¡'a'-97"                  : (1, [[0,2,0,0,0,4,17,0,1,0,3,17,7],[runtime[1],runtime[18],97,'\0','a'],[[0,1,0]],[[0,0]]]),
            "3â‰¡'d'-'a'"                 : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[1],runtime[18],3,'d','a'],[[0,1,0]],[[0,0]]]),
            "'Q'â‰¡'q'+'A'-'a'"           : (1, [[0,6,0,1,0,5,17,0,0,0,4,17,0,2,0,3,17,7],[runtime[0],runtime[1],runtime[18],'Q','q','A','a'],[[0,1,0]],[[0,0]]]),
            "97-'a'"                    : (TypeError, [[0,2,0,0,0,1,17,7],[runtime[1],97,'a'],[[0,1,0]],[[0,0]]]),
            "@-1"                       : (ValueError, [[0,1,0,0,0,2,17,7],[runtime[1],1,'\0'],[[0,1,0]],[[0,0]]]),
            "-'a'"                      : (TypeError, [[0,1,0,0,16,7],[runtime[1],'a'],[[0,1,0]],[[0,0]]]),
            "Fâ†Ã·â‹„-f"                    : (TypeError, [[0,1,33,0,0,48,6,34,0,0,0,0,16,7],[runtime[1],runtime[3]],[[0,1,0]],[[0,1]]]),
            "1.5â‰¡3Ã—0.5"                 : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[2],runtime[18],1.5,3,0.5],[[0,1,0]],[[0,0]]]),
            "2Ã—'a'"                     : (TypeError, [[0,2,0,0,0,1,17,7],[runtime[2],2,'a'],[[0,1,0]],[[0,0]]]),
            "4â‰¡Ã·0.25"                   : (1, [[0,3,0,0,16,0,1,0,2,17,7],[runtime[3],runtime[18],4,0.25],[[0,1,0]],[[0,0]]]),
            "âˆâ‰¡Ã·0"                      : (1, [[0,3,0,0,16,0,1,0,2,17,7],[runtime[3],runtime[18],math.inf,0],[[0,1,0]],[[0,0]]]),
            "0â‰¡Ã·âˆ"                      : (1, [[0,3,0,0,16,0,1,0,2,17,7],[runtime[3],runtime[18],0,math.inf],[[0,1,0]],[[0,0]]]),
            "Ã·'b'"                      : (TypeError, [[0,1,0,0,16,7],[runtime[3],'b'],[[0,1,0]],[[0,0]]]),
            "Fâ†âˆš-â‹„Ã·f"                   : (TypeError, [[0,0,0,2,20,33,0,0,48,6,34,0,0,0,1,16,7],[runtime[1],runtime[3],runtime[5]],[[0,1,0]],[[0,1]]]),
            "1â‰¡â‹†0"                      : (1, [[0,3,0,0,16,0,1,0,2,17,7],[runtime[4],runtime[18],1,0],[[0,1,0]],[[0,0]]]),
            "Â¯1â‰¡Â¯1â‹†5"                   : (1, [[0,3,0,0,0,2,17,0,1,0,2,17,7],[runtime[4],runtime[18],-1,5],[[0,1,0]],[[0,0]]]),
            "1â‰¡Â¯1â‹†Â¯6"                   : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[4],runtime[18],1,-1,-6],[[0,1,0]],[[0,0]]]),
            "â‹†'Ï€'"                      : (TypeError, [[0,1,0,0,16,7],[runtime[4],'Ï€'],[[0,1,0]],[[0,0]]]),
            "'e'â‹†'Ï€'"                   : (TypeError, [[0,2,0,0,0,1,17,7],[runtime[4],'e','Ï€'],[[0,1,0]],[[0,0]]]),
            "3â‰¡âŒŠ3.9"                    : (1, [[0,3,0,0,16,0,1,0,2,17,7],[runtime[6],runtime[18],3,3.9],[[0,1,0]],[[0,0]]]),
            "Â¯4â‰¡âŒŠÂ¯3.9"                  : (1, [[0,3,0,0,16,0,1,0,2,17,7],[runtime[6],runtime[18],-4,-3.9],[[0,1,0]],[[0,0]]]),
            "âˆâ‰¡âŒŠâˆ"                      : (1, [[0,2,0,0,16,0,1,0,2,17,7],[runtime[6],runtime[18],math.inf],[[0,1,0]],[[0,0]]]),
            "Â¯âˆâ‰¡âŒŠÂ¯âˆ"                    : (1, [[0,2,0,0,16,0,1,0,2,17,7],[runtime[6],runtime[18],-math.inf],[[0,1,0]],[[0,0]]]),
            "Â¯1e30â‰¡âŒŠÂ¯1e30"              : (1, [[0,2,0,0,16,0,1,0,2,17,7],[runtime[6],runtime[18],-1e30],[[0,1,0]],[[0,0]]]),
            "Fâ†âŒˆâ‹„âŒŠf"                    : (TypeError, [[0,1,33,0,0,48,6,34,0,0,0,0,16,7],[runtime[6],runtime[7]],[[0,1,0]],[[0,1]]]),
            "1â‰¡1=1"                     : (1, [[0,2,0,0,0,2,17,0,1,0,2,17,7],[runtime[15],runtime[18],1],[[0,1,0]],[[0,0]]]),
            "0â‰¡Â¯1=âˆ"                    : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[15],runtime[18],0,-1,math.inf],[[0,1,0]],[[0,0]]]),
            "1â‰¡'a'='a'"                 : (1, [[0,3,0,0,0,3,17,0,1,0,2,17,7],[runtime[15],runtime[18],1,'a'],[[0,1,0]],[[0,0]]]),
            "0â‰¡'a'='A'"                 : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[15],runtime[18],0,'a','A'],[[0,1,0]],[[0,0]]]),
            "1â‰¡{Fâ†+â‹„f=f}"               : (1, [[1,1,0,2,0,3,17,7,0,0,33,0,0,48,6,32,0,0,0,1,34,0,0,17,7],[runtime[0],runtime[15],runtime[18],1],[[0,1,0],[0,1,1]],[[0,0],[8,1]]]),
            "1â‰¡{aâ€¿bâ†âŸ¨+Â´,+Â´âŸ©â‹„a=b}"       : (1, [[1,1,0,2,0,4,17,7,0,3,0,0,26,0,3,0,0,26,11,2,33,0,0,33,0,1,12,2,48,6,34,0,1,0,1,34,0,0,17,7],[runtime[0],runtime[15],runtime[18],runtime[50],1],[[0,1,0],[0,1,1]],[[0,0],[8,2]]]),
            "0â‰¡{_opâ†{ğ•—}â‹„op='o'}"        : (1, [[1,1,0,1,0,2,17,7,1,2,33,0,0,48,6,0,3,0,0,34,0,0,17,7,34,0,1,7],[runtime[15],runtime[18],0,'o'],[[0,1,0],[0,1,1],[1,1,2]],[[0,0],[8,1],[24,2]]]),
            "0â‰¡{Fâ†{ğ•©}â‹„Gâ†{ğ•©}â‹„f=g}"       : (1, [[1,1,0,1,0,2,17,7,1,2,33,0,0,48,6,1,3,33,0,1,48,6,34,0,1,0,0,34,0,0,17,7,34,0,1,7,34,0,1,7],[runtime[15],runtime[18],0],[[0,1,0],[0,1,1],[0,0,2],[0,0,3]],[[0,0],[8,2],[32,3],[36,3]]]),
            "1â‰¡{Fâ†{ğ•©}â‹„f=f}"             : (1, [[1,1,0,1,0,2,17,7,1,2,33,0,0,48,6,32,0,0,0,0,34,0,0,17,7,34,0,1,7],[runtime[15],runtime[18],1],[[0,1,0],[0,1,1],[0,0,2]],[[0,0],[8,1],[25,3]]]),
            "1â‰¡1â‰¤1"                     : (1, [[0,2,0,0,0,2,17,0,1,0,2,17,7],[runtime[16],runtime[18],1],[[0,1,0]],[[0,0]]]),
            "1â‰¡Â¯âˆâ‰¤Â¯1e3"                 : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[16],runtime[18],1,-math.inf,-1000],[[0,1,0]],[[0,0]]]),
            "0â‰¡âˆâ‰¤Â¯âˆ"                    : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[16],runtime[18],0,math.inf,-math.inf],[[0,1,0]],[[0,0]]]),
            "1â‰¡âˆâ‰¤@"                     : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[16],runtime[18],1,math.inf,'\0'],[[0,1,0]],[[0,0]]]),
            "0â‰¡'z'â‰¤Â¯0.5"                : (1, [[0,3,0,0,0,4,17,0,1,0,2,17,7],[runtime[16],runtime[18],0,-0.5,'z'],[[0,1,0]],[[0,0]]]),
            "1â‰¡'a'â‰¤'a'"                 : (1, [[0,3,0,0,0,3,17,0,1,0,2,17,7],[runtime[16],runtime[18],1,'a'],[[0,1,0]],[[0,0]]]),
            "0â‰¡'c'â‰¤'a'"                 : (1, [[0,4,0,0,0,3,17,0,1,0,2,17,7],[runtime[16],runtime[18],0,'c','a'],[[0,1,0]],[[0,0]]]),
            "Fâ†+â‹„Gâ†-â‹„fâ‰¤g"               : (TypeError, [[0,0,33,0,0,48,6,0,1,33,0,1,48,6,34,0,1,0,2,34,0,0,17,7],[runtime[0],runtime[1],runtime[16]],[[0,1,0]],[[0,2]]]),
            "âŸ¨âŸ©â‰¡â‰¢<2"                    : (1, [[0,3,0,0,16,0,2,16,0,1,11,0,17,7],[runtime[12],runtime[18],runtime[19],2],[[0,1,0]],[[0,0]]]),
            'âŸ¨3âŸ©â‰¡â‰¢"abc"'                : (1, [[0,3,0,1,16,0,0,0,2,11,1,17,7],[runtime[18],runtime[19],3,bqnstr("abc")],[[0,1,0]],[[0,0]]]),
            'âŸ¨2,3âŸ©â‰¡â‰¢>"abc"â€¿"fed"'       : (1, [[0,5,0,6,11,2,0,0,16,0,2,16,0,1,0,3,0,4,11,2,17,7],[runtime[13],runtime[18],runtime[19],2,3,bqnstr("abc"),bqnstr("fed")],[[0,1,0]],[[0,0]]]),
            'âŸ¨2,3,4,5âŸ©â‰¡â‰¢2â€¿3â€¿4â€¿5â¥Šâ†•120'   : (1, [[0,8,0,3,16,0,2,0,4,0,5,0,6,0,7,11,4,17,0,1,16,0,0,0,4,0,5,0,6,0,7,11,4,17,7],[runtime[18],runtime[19],runtime[22],runtime[28],2,3,4,5,120],[[0,1,0]],[[0,0]]]),
            'âŸ¨6âŸ©â‰¡â‰¢â¥Š>"abc"â€¿"fed"'        : (1, [[0,5,0,6,11,2,0,0,16,0,3,16,0,2,16,0,1,0,4,11,1,17,7],[runtime[13],runtime[18],runtime[19],runtime[22],6,bqnstr("abc"),bqnstr("fed")],[[0,1,0]],[[0,0]]]),
            '"abc"â‰¡0âŠ‘"abc"â€¿"de"'        : (1, [[0,3,0,4,11,2,0,1,0,2,17,0,0,0,3,17,7],[runtime[18],runtime[37],0,bqnstr("abc"),bqnstr("de")],[[0,1,0]],[[0,0]]]),
            '"de"â‰¡1âŠ‘"abc"â€¿"de"'         : (1, [[0,4,0,3,11,2,0,1,0,2,17,0,0,0,3,17,7],[runtime[18],runtime[37],1,bqnstr("de"),bqnstr("abc")],[[0,1,0]],[[0,0]]]),
            "âŸ¨âŸ©â‰¡â†•0"                     : (1, [[0,2,0,1,16,0,0,11,0,17,7],[runtime[18],runtime[28],0],[[0,1,0]],[[0,0]]]),
            "âŸ¨0âŸ©â‰¡â†•1"                    : (1, [[0,3,0,1,16,0,0,0,2,11,1,17,7],[runtime[18],runtime[28],0,1],[[0,1,0]],[[0,0]]]),
            "âŸ¨0,1,2,3,4,5,6âŸ©â‰¡â†•7"        : (1, [[0,9,0,1,16,0,0,0,2,0,3,0,4,0,5,0,6,0,7,0,8,11,7,17,7],[runtime[18],runtime[28],0,1,2,3,4,5,6,7],[[0,1,0]],[[0,0]]]),
            "1â‰¡!1"                      : (1, [[0,2,0,1,16,0,0,0,2,17,7],[runtime[18],runtime[43],1],[[0,1,0]],[[0,0]]]),
            "1â‰¡'e'!1"				    : (1, [[0,2,0,1,0,3,17,0,0,0,2,17,7],[runtime[18],runtime[43],1,'e'],[[0,1,0]],[[0,0]]]),
            "!0"                        : (AssertionError, [[0,1,0,0,16,7],[runtime[43],0],[[0,1,0]],[[0,0]]]),
            '"error"!"abc"'             : (AssertionError, [[0,2,0,0,0,1,17,7],[runtime[43],bqnstr("error"),bqnstr("abc")],[[0,1,0]],[[0,0]]]),
        }
        # fmt: on

        for case, (expected, input) in cases.items():
            with self.subTest(case=case):
                if inspect.isclass(expected) and issubclass(expected, Exception):
                    with self.assertRaises(expected):
                        self.assertEqual(VM(*input)(), expected)
                else:
                    out = VM(*input)()
                    self.assertEqual(out, expected)


if __name__ == "__main__":
    unittest.main()
