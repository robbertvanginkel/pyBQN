import unittest

from . import VM


class ByteCodeTest(unittest.TestCase):
    """https://github.com/mlochbaum/BQN/blob/master/test/cases/bytecode.bqn"""
    # fmt: off
    cases = {
        "5"                        : (5, [[0,0,7],[5],[[0,1,0]],[[0,0]]]),
        "4â‹„3"                      : (3, [[0,0,6,0,1,7],[4,3],[[0,1,0]],[[0,0]]]),
        "aâ†5"                      : (5, [[0,0,33,0,0,48,7],[5],[[0,1,0]],[[0,1]]]),
        "aâ†5â‹„aâ†©4"                  : (4, [[0,0,33,0,0,48,6,0,1,33,0,0,49,7],[5,4],[[0,1,0]],[[0,1]]]),
        "aâ†2â‹„bâ†3â‹„a"                : (2, [[0,0,33,0,0,48,6,0,1,33,0,1,48,6,34,0,0,7],[2,3],[[0,1,0]],[[0,2]]]),
        "aâ†1â‹„A 4"                  : (1, [[0,0,33,0,0,48,6,34,0,0,7],[1],[[0,1,0]],[[0,1]]]),
        "aâ†2â‹„3 A 4"                : (2, [[0,0,33,0,0,48,6,0,2,34,0,0,0,1,17,7],[2,3,4],[[0,1,0]],[[0,1]]]),
        "{ğ•©}6"                     : (6, [[0,0,1,1,16,7,34,0,1,7],[6],[[0,1,0],[0,0,1]],[[0,0],[6,3]]]),
        "Aâ†{ğ•¨}â‹„3 A 4"              : (3, [[1,1,33,0,0,48,6,0,1,34,0,0,0,0,17,7,34,0,2,7],[3,4],[[0,1,0],[0,0,[[],[1]]]],[[0,1],[16,3]]]),
        "aâ€¿bâ†7â€¿2â‹„a"                : (7, [[0,0,0,1,11,2,33,0,0,33,0,1,12,2,48,6,34,0,0,7],[7,2],[[0,1,0]],[[0,2]]]),
        "Â·â€¿bâ†7â€¿2â‹„b"                : (2, [[0,0,0,1,11,2,44,33,0,0,12,2,48,6,34,0,0,7],[7,2],[[0,1,0]],[[0,1]]]),
        "0{ğ•¨ğ•1}2"                  : (2, [[0,2,1,1,0,0,17,7,0,1,34,0,1,34,0,2,19,7],[0,1,2],[[0,1,0],[0,0,1]],[[0,0],[8,3]]]),
        "{({ğ•¨}ğ•¨)ğ•ğ•©}5"              : (5, [[0,0,1,1,16,7,32,0,1,34,0,1,34,0,2,1,2,18,19,7,34,0,2,7],[5],[[0,1,0],[0,0,1],[0,0,[[],[2]]]],[[0,0],[6,3],[20,3]]]),
        "{ğ•©{aâ€¿bâ†ğ•¨}ğ•¨,ğ•©}8"           : (8, [[0,0,1,1,16,7,34,0,2,1,2,32,0,1,19,6,34,0,1,7,34,0,2,33,0,3,33,0,4,12,2,48,7],[8],[[0,1,0],[0,0,1],[0,0,[[],[2]]]],[[0,0],[6,3],[20,5]]]),
        "4{ğ”½}"                     : (4, [[1,1,0,0,26,7,34,0,1,7],[4],[[0,1,0],[1,1,1]],[[0,0],[6,2]]]),
        "4{ğ”½â‹„ğ•©}6"                  : (6, [[0,1,1,1,0,0,26,16,7,34,0,4,6,34,0,1,7],[4,6],[[0,1,0],[1,0,1]],[[0,0],[9,5]]]),
        "3{ğ”¾}{ğ•©} 1"                : (1, [[0,1,1,1,1,2,0,0,27,16,7,34,0,1,7,34,0,2,7],[3,1],[[0,1,0],[0,0,1],[2,1,2]],[[0,0],[11,3],[15,3]]]),
        "(2{ğ”½}{ğ•©})3"               : (2, [[0,1,1,1,1,2,0,0,26,20,16,7,34,0,1,7,34,0,1,7],[2,3],[[0,1,0],[0,0,1],[1,1,2]],[[0,0],[12,3],[16,2]]]),
        "3({aâ€¿bâ†ğ•©â‹„a}{ğ•¨â€¿ğ•©})4"       : (3, [[0,1,1,1,1,2,20,0,0,17,7,34,0,2,34,0,1,11,2,7,34,0,1,33,0,3,33,0,4,12,2,48,6,34,0,3,7],[3,4],[[0,1,0],[0,0,[[],[1]]],[0,0,2]],[[0,0],[11,3],[20,5]]]),
        "4({ğ•¨â€¿ğ•©}{ğ•©}{ğ•¨})5"          : (4, [[0,1,1,1,1,2,1,3,21,0,0,17,7,34,0,2,7,34,0,1,7,34,0,2,34,0,1,11,2,7],[4,5],[[0,1,0],[0,0,[[],[1]]],[0,0,2],[0,0,[[],[3]]]],[[0,0],[13,3],[17,3],[21,3]]]),
        "aâ€¿bâ†(2{ğ•¨â€¿ğ•©}{ğ•©})5â‹„a"       : (2, [[0,1,1,1,1,2,0,0,21,16,33,0,0,33,0,1,12,2,48,6,34,0,0,7,34,0,1,7,34,0,2,34,0,1,11,2,7],[2,5],[[0,1,0],[0,0,1],[0,0,[[],[2]]]],[[0,2],[24,3],[28,3]]]),
        "({aâ†©2â‹„ğ•©}{ğ•©â‹„a}{aâ†©3â‹„ğ•©})aâ†4" : (2, [[0,2,33,0,0,48,1,1,1,2,1,3,21,16,7,0,1,33,1,0,49,6,34,0,1,7,34,0,1,6,32,1,0,7,0,0,33,1,0,49,6,34,0,1,7],[2,3,4],[[0,1,0],[0,0,1],[0,0,2],[0,0,3]],[[0,1],[15,3],[26,3],[34,3]]]),
        "aâ†3â‹„a{ğ•©}â†©8â‹„a"             : (8, [[0,0,33,0,0,48,6,0,1,1,1,33,0,0,50,6,34,0,0,7,34,0,1,7],[3,8],[[0,1,0],[0,0,1]],[[0,1],[20,3]]]),
        "aâ†4â‹„a{ğ•¨â‹„5}â†©6"             : (5, [[0,0,33,0,0,48,6,0,2,1,1,33,0,0,50,7,34,0,2,6,0,1,7],[4,5,6],[[0,1,0],[0,0,1]],[[0,1],[16,3]]]),
        "aâ†3â‹„a{ğ•©â‹„1}â†©â‹„a"            : (1, [[0,0,33,0,0,48,6,1,1,33,0,0,51,6,34,0,0,7,34,0,1,6,0,1,7],[3,1],[[0,1,0],[0,0,1]],[[0,1],[18,3]]]),
        "aâ€¿bâ†2â€¿1â‹„aâ€¿b{ğ•©â€¿ğ•¨}â†©4â‹„a"     : (4, [[0,0,0,1,11,2,33,0,0,33,0,1,12,2,48,6,0,2,1,1,33,0,0,33,0,1,12,2,50,6,34,0,0,7,34,0,1,34,0,2,11,2,7],[2,1,4],[[0,1,0],[0,0,[[],[1]]]],[[0,2],[34,3]]]),

        "{ğ•¨{aâ†ğ•©â‹„{aâ†©ğ•©}ğ•¨â‹„a}ğ•©}7"      : (7, [[0,0,1,1,16,7,34,0,1,1,2,34,0,2,19,7,34,0,1,33,0,3,48,6,34,0,2,1,3,18,6,32,0,3,7,34,0,1,33,1,3,49,7],[7],[[0,1,0],[0,0,1],[0,0,2],[0,0,3]],[[0,0],[6,3],[16,4],[35,3]]]),
        "3{ğ•¨{aâ†ğ•©â‹„{aâ†©ğ•©}ğ•¨â‹„a}ğ•©}7"     : (3, [[0,1,1,1,0,0,17,7,34,0,1,1,2,34,0,2,19,7,34,0,1,33,0,3,48,6,34,0,2,1,3,18,6,32,0,3,7,34,0,1,33,1,3,49,7],[3,7],[[0,1,0],[0,0,1],[0,0,2],[0,0,3]],[[0,0],[8,3],[18,4],[37,3]]]),
        "{ğ•0} {ğ•¨{aâ†ğ•©â‹„{aâ†©ğ•©}ğ•¨â‹„a}ğ•}7" : (7, [[0,1,1,1,16,1,2,16,7,34,0,1,1,3,34,0,2,23,7,0,0,34,0,1,16,7,34,0,1,33,0,3,48,6,34,0,2,1,4,18,6,32,0,3,7,34,0,1,33,1,3,49,7],[0,7],[[0,1,0],[0,0,1],[0,0,2],[0,0,3],[0,0,4]],[[0,0],[9,3],[19,3],[26,4],[45,3]]]),
        "{ğ•0}3{ğ•¨{aâ†ğ•©â‹„{aâ†©ğ•©}ğ•¨â‹„a}ğ•}7" : (3, [[0,2,1,1,0,1,17,1,2,16,7,34,0,1,1,3,34,0,2,23,7,0,0,34,0,1,16,7,34,0,1,33,0,3,48,6,34,0,2,1,4,18,6,32,0,3,7,34,0,1,33,1,3,49,7],[0,3,7],[[0,1,0],[0,0,1],[0,0,2],[0,0,3],[0,0,4]],[[0,0],[11,3],[21,3],[28,4],[47,3]]]),
        
        "aâ†1â‹„{aâ†2}â‹„a"                   : (1, [[0,0,33,0,0,48,6,1,1,6,34,0,0,7,0,1,33,0,0,48,7],[1,2],[[0,1,0],[0,1,1]],[[0,1],[14,1]]]),
        "aâ†1â‹„{aâ†©2}â‹„a"                   : (2, [[0,0,33,0,0,48,6,1,1,6,32,0,0,7,0,1,33,1,0,49,7],[1,2],[[0,1,0],[0,1,1]],[[0,1],[14,0]]]),
        "fâ€¿gâ†{aâ†2â‹„{aâ†©ğ•©}â€¿{ğ•©â‹„a}}â‹„F 6â‹„G 0" : (6, [[1,1,33,0,0,33,0,1,12,2,48,6,0,1,34,0,0,16,6,0,2,34,0,1,16,7,0,0,33,0,0,48,6,1,2,1,3,11,2,7,34,0,1,33,1,0,49,7,34,0,1,6,32,1,0,7],[2,6,0],[[0,1,0],[0,1,1],[0,0,2],[0,0,3]],[[0,2],[26,1],[40,3],[48,3]]]),
        "Lâ†{ğ•©{ğ•ğ•—}}â‹„{ğ•ğ•¤}L L L 5"         : (5, [[1,1,33,0,0,48,6,0,0,32,0,0,16,32,0,0,16,34,0,0,16,1,2,16,7,1,3,34,0,1,26,7,34,0,0,34,0,1,16,7,34,0,4,34,0,1,16,7],[5],[[0,1,0],[0,0,1],[0,0,2],[1,0,3]],[[0,1],[25,3],[32,3],[40,5]]]),
        "_lâ†{ğ•©{ğ•ğ•—} ğ”½}â‹„{ğ•ğ•¤} {ğ•©}_l 3 _l 5": (3, [[1,1,33,0,0,48,6,0,1,32,0,0,0,0,26,16,34,0,0,1,2,26,16,1,3,16,7,34,0,4,1,4,34,0,1,26,20,7,34,0,1,7,34,0,0,34,0,1,16,7,34,0,4,34,0,1,16,7],[3,5],[[0,1,0],[1,0,1],[0,0,2],[0,0,3],[1,0,4]],[[0,1],[27,5],[38,3],[42,3],[50,5]]]),
        "1{ğ•¨}{ğ”½{ğ•©ğ”½ğ•¨}ğ”¾ğ”½}{ğ•©}0"            : (1, [[0,1,1,1,1,2,1,3,27,0,0,17,7,34,0,1,7,32,0,1,34,0,2,1,4,34,0,1,26,21,7,34,0,2,7,34,0,2,34,0,4,34,0,1,17,7],[1,0],[[0,1,0],[0,0,1],[2,1,2],[0,0,[[],[3]]],[1,0,[[],[4]]]],[[0,0],[13,3],[17,3],[31,3],[35,5]]]),
        # "0â€¿(0â€¿{ğ•©}){{aâ€¿bâ†ğ•©â‹„tâ†ğ•¤â‹„{ğ•¤â‹„Tâ†©{ğ•¤â‹„{aâ€¿bâ†ğ•©â‹„a}}}{Bğ•—}0â‹„(T b){aâ€¿bâ†ğ•©â‹„ğ”½b}}ğ•—} 0â€¿(1â€¿(2â€¿(3â€¿(4â€¿{ğ•©}))))": (2, [[0,0,0,1,0,2,0,3,0,4,1,1,11,2,11,2,11,2,11,2,11,2,1,2,0,0,0,0,1,3,11,2,11,2,26,16,7,34,0,1,7,34,0,1,1,4,16,7,34,0,1,7,34,0,1,33,0,3,33,0,4,12,2,48,6,34,0,0,33,0,5,48,6,0,0,1,5,1,6,26,16,6,1,7,32,0,4,32,0,5,16,26,7,34,0,1,32,1,4,16,7,34,0,0,6,1,8,33,1,5,49,7,34,0,1,33,0,5,33,0,6,12,2,48,6,34,0,6,34,0,4,16,7,34,0,0,6,1,9,7,34,0,1,33,0,3,33,0,4,12,2,48,6,34,0,3,7],[0,1,2,3,4],[[0,1,0],[0,0,1],[1,1,2],[0,0,3],[0,0,4],[1,1,5],[0,0,6],[1,0,7],[0,0,8],[0,0,9]],[[0,0],[37,3],[41,2],[48,3],[52,6],[93,2],[101,3],[112,7],[133,3],[140,5]]]),
    }
    # fmt: on

    def test_vm(self):
        for case, (expected, input) in self.cases.items():
            with self.subTest(case=case):
                self.assertEqual(VM(*input)(), expected)


if __name__ == "__main__":
    unittest.main()
